
# Terraform Cloud Foundation for Network Management
# Terraform setup for Resource Management

# GCP Resource Manager module

This module manages the objects related to Google Cloud Resource Manager.

There are two versions of the module: **basic** and **advanced**.

The **basic version** will manage Folders, Projects and API's within projects.

The **advanced** version will have all the features of the basic version, and additionally manages Policies at the Org, Folder and Project level.

| Feature               | Basic | Advanced |
|-----------------------|-------|----------|
| Folders               |   x   |     x    |
| Projects              |   x   |     x    |
| Organization Policies |       |     x    |
| Folder Policies       |       |     x    |
| Project Policies      |       |     x    |


## Required Permissions

Depending on whether you're deploying the basic or advanced version, the Service Account needs specific IAM grants on the GPC Organization.
These should have been granted using the IAM module of the Cloud Foundations repository, an example can be found [here](https://github.com/devoteamgcloud/tf-gcp-foundation-samples-iam/blob/main/iam-advanced-admin/sample.tfvars#L167).

| IAM Role                             | Basic | Advanced |
|--------------------------------------|-------|----------|
| roles/resourcemanager.folderAdmin    |   x   |     x    |
| roles/resourcemanager.projectCreator |   x   |     x    |
| roles/orgpolicy.policyAdmin          |       |     x    |
| roles/serviceusage.serviceUsageAdmin |       |     x    |


### IAM roles
The IAM admin module on the Basic level must have already run, so that the Service Account (SA) has been created.
When using the basic package, access to resource creation roles needs to be given to the SA manually.
This can be done through the console, or by following the extra steps for basic package below.

When using the Advanced module, the Service Account and the Organization-level IAM bindings should have been created
so that the admins can retrieve a key for the Service Account.

### Terraform state bucket

If using the basic package, you will need to create a new bucket in the same way as how you created one for the IAM module.
In that case, follow the extra steps for basic package below.

If using the advanced package, the IAM admin module should also already have been used to create a GCS
bucket for the terraform state of this module, and given the related SA access to write to the bucket.

## Setup

### 1. Variables
replace the below variables accordingly. To retrieve *Organization ID* using the command below. This command will show a table with all domains where your user account has access on. The *Organization ID* is the `ID` column. It's required in `.tfvars` of the both the Basic and Advanced module, as well as in Step 3 below for the Basic module.
```shell
gcloud organizations list
```

**Replace all exported variables accordingly.**
```shell
export TF_SA_VPC="sa-cf-tf-basic-vpc@pj-cf-basic-terraform-master.iam.gserviceaccount.com"
```

### 2. Download the key for the SA

```shell
gcloud iam service-accounts keys create resources/key.json --iam-account=$TF_SA_VPC
```


### 3. [BASIC ONLY] Extra steps
To grant the service account created by the IAM module the necessary organization level access, use following commands.
**Replace all exported variables accordingly.**

```shell
export ORG_ID=132905988165
export PROJECT_ID=pj-cf-basic-terraform-master
export TF_ROOT_STATE_BUCKET_VPC=cf-basic-vpc-tf-state

gsutil mb -l EU -p $PROJECT_ID gs://$TF_ROOT_STATE_BUCKET_VPC
gsutil versioning set on gs://$TF_ROOT_STATE_BUCKET_VPC
gsutil iam ch "serviceAccount:${TF_SA_VPC}:roles/storage.objectAdmin" gs://$TF_ROOT_STATE_BUCKET_VPC

gcloud organizations add-iam-policy-binding $ORG_ID \
--member="serviceAccount:$TF_SA_VPC" \
--role="roles/compute.networkAdmin"

gcloud organizations add-iam-policy-binding $ORG_ID \
--member="serviceAccount:$TF_SA_VPC" \
--role="oles/compute.securityAdmin" #required for firewalls
```


## Terraform autogenerated docs

<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->






The IAM admin module on the Admin level must have already run, so that the Service Account (SA) has been created, a group
for the administrators has been defined and that group has been given access to retrieve the key for the SA.

When using the basic package, access to network management roles needs to be given to the SA manually. This can be done through the console,
or by following the extra steps for basic package below. Alternatively, you can set the folder or project level roles using the IAM module.
## Terraform autogenerated docs

<!-- BEGINNING OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
<!-- END OF PRE-COMMIT-TERRAFORM DOCS HOOK -->
